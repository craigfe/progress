<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make (progress.Progress_engine.Make)</title><link rel="stylesheet" href="../../../_odoc_support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">progress</a> &#x00BB; <a href="../index.html">Progress_engine</a> &#x00BB; Make</nav><header class="odoc-preamble"><h1>Module <code><span>Progress_engine.Make</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#parameters">Parameters</a></li><li><a href="#signature">Signature</a></li><li><a href="#preliminaries">Preliminaries</a></li><li><a href="#description">Description</a><ul><li><a href="#pre-provided-lines">Pre-provided lines</a></li></ul></li><li><a href="#rendering">Rendering</a><ul><li><a href="#examples_8">Examples</a></li><li><a href="#logging-during-rendering">Logging during rendering</a></li><li><a href="#manual-lifecycle-management">Manual lifecycle management</a></li></ul></li></ul></nav><div class="odoc-content"><h2 id="parameters"><a href="#parameters" class="anchor"></a>Parameters</h2><div class="odoc-spec"><div class="spec parameter" id="argument-1-_" class="anchored"><a href="#argument-1-_" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="argument-1-_/index.html">_</a></span><span> : <a href="../module-type-Platform/index.html">Platform</a></span></code></div></div><h2 id="signature"><a href="#signature" class="anchor"></a>Signature</h2><h2 id="preliminaries"><a href="#preliminaries" class="anchor"></a>Preliminaries</h2><p>Some basic types used throughout the rest of the library:</p><div class="odoc-spec"><div class="spec module" id="module-Color" class="anchored"><a href="#module-Color" class="anchor"></a><code><span><span class="keyword">module</span> Color</span><span> = <a href="../../../terminal/Terminal/Color/index.html">Terminal.Color</a></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Duration" class="anchored"><a href="#module-Duration" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Duration/index.html">Duration</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Printer" class="anchored"><a href="#module-Printer" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Printer/index.html">Printer</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Units" class="anchored"><a href="#module-Units" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Units/index.html">Units</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Pretty-printing utilities for common units used in progress bars.</p></div></div><h2 id="description"><a href="#description" class="anchor"></a>Description</h2><p>Describing a progress line is done via the <a href="Line/index.html"><code>Line</code></a> DSL. Individual lines can be stacked vertically via <a href="Multi/index.html"><code>Multi</code></a>.</p><div class="odoc-spec"><div class="spec module" id="module-Line" class="anchored"><a href="#module-Line" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Line/index.html">Line</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Multi" class="anchored"><a href="#module-Multi" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Multi/index.html">Multi</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><h3 id="pre-provided-lines"><a href="#pre-provided-lines" class="anchor"></a>Pre-provided lines</h3><div class="odoc-spec"><div class="spec value" id="val-counter" class="anchored"><a href="#val-counter" class="anchor"></a><code><span><span class="keyword">val</span> counter : 
  <span>?style:<span>[ `ASCII <span>| `UTF8</span> <span><span>| `Custom</span> of <a href="Line/Bar_style/index.html#type-t">Line.Bar_style.t</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?message:string <span class="arrow">&#45;&gt;</span></span>
  <span>?pp:<span>int64 <a href="Printer/index.html#type-t">Printer.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>int64 <span class="arrow">&#45;&gt;</span></span>
  <span>int64 <a href="Line/index.html#type-t">Line.t</a></span></span></code></div><div class="spec-doc"><p><code>counter total</code> is a progress bar of the form:</p><pre><code>&lt;message?&gt; &lt;count?&gt; MM:SS [########..............................]  XX%</code></pre><p>where each reported value contributes cumulatively towards an eventual total of <code>total</code>. <code>?style</code> specifies the <a href="Line/Bar_style/index.html#type-t"><code>Bar_style.t</code></a> to use for rendering the bar, and <code>?pp</code> is used to pretty-print the <code>&lt;count&gt;</code> segment, if passed. (For example, <a href="Units/Bytes/index.html#val-of_int64"><code>Units.Bytes.of_int64</code></a> can be used for totals measured in bytes.)</p></div></div><h2 id="rendering"><a href="#rendering" class="anchor"></a>Rendering</h2><p>Once you have a <a href="#description">description</a> of the progress bar to be rendered (either a <a href="Line/index.html#type-t"><code>Line.t</code></a> or a <a href="Multi/index.html#type-t"><code>Multi.t</code></a>), begin rendering it by using <a href="#val-with_reporter"><code>with_reporter</code></a> or <a href="#val-with_reporters"><code>with_reporters</code></a> respectively.</p><div class="odoc-spec"><div class="spec type subst" id="type-reporter" class="anchored"><a href="#type-reporter" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a reporter</span></span><span> := <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>A <i>reporter</i> for values of type <code>'a</code>. In this library, each progress line has its own reporting function.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Config" class="anchored"><a href="#module-Config" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Config/index.html">Config</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Configuration for progress bar rendering.</p></div></div><div class="odoc-include"><div class="odoc-spec"><div class="spec value" id="val-with_reporter" class="anchored"><a href="#val-with_reporter" class="anchor"></a><code><span><span class="keyword">val</span> with_reporter : 
  <span>?config:<a href="Config/index.html#type-t">Config.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="Line/index.html#type-t">Line.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><span><span class="type-var">'a</span> <a href="#type-reporter">reporter</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p><code>with_reporters line f</code> begins rendering <code>line</code> and calls <code>f</code> with the reporting function. Once <code>f</code> returns, the display is finalised. <b>Note:</b> attempting to use the reporting function after <code>f</code> has returned will raise a <code>Finalised</code> exception.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_reporters" class="anchored"><a href="#val-with_reporters" class="anchor"></a><code><span><span class="keyword">val</span> with_reporters : <span>?config:<a href="Config/index.html#type-t">Config.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>( <span class="type-var">'a</span>, <span class="type-var">'b</span> )</span> <a href="Multi/index.html#type-t">Multi.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p><code>with_reporters bars f</code> begins rendering <code>bars</code> and passes the corresponding reporting functions to <code>f</code>. Once <code>f</code> returns, the display is finalised.</p></div></div><h4 id="examples_8"><a href="#examples_8" class="anchor"></a>Examples</h4><ul><li>Reading a file into memory and displaying a single progress bar:</li></ul><pre><code>let read_file path buffer =
  let total = file_size path and in_channel = open_in path in
  try
    with_reporter (counter ~total ()) @@ fun report -&gt;
    let rec aux offset =
      let bytes_read = really_read buffer offset in
      report bytes_read;
      aux (offset + bytes_read)
    in
    aux 0
  with End_of_file -&gt; close_in in_channel</code></pre><ul><li>Sending data to multiple clients, with one progress bar each:</li></ul><pre><code>let multi_bar_rendering () =
  with_reporters
    Multi.(line bar_a ++ line bar_b ++ line bar_c)
    (fun report_a report_b report_c -&gt;
      for i = 1 to 1000 do
        report_a (transfer_bytes client_a);
        report_b (transfer_bytes client_b);
        report_c (transfer_bytes client_c)
      done)</code></pre><h4 id="logging-during-rendering"><a href="#logging-during-rendering" class="anchor"></a>Logging during rendering</h4><div class="odoc-spec"><div class="spec value" id="val-interject_with" class="anchored"><a href="#val-interject_with" class="anchor"></a><code><span><span class="keyword">val</span> interject_with : <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span> )</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>interject_with f</code> executes the function <code>f</code> while temporarily suspending the rendering of any active progress bar display. This can be useful when printing to <code>stdout</code> / <code>stderr</code>, to avoid any interference from the rendering of progress bars. If using the <code>Logs</code> library, consider using <a href="#type-reporter"><code>reporter</code></a> and <code>instrument_reporter</code> instead.</p><p><b>Note</b>: <i>the caller must ensure that the terminal cursor is left in an appropriate position to resume rendering. In practice, this means that any printing to the terminal should be terminated with a newline character and flushed.</i></p></div></div><p>Extensions to the <a href="https://erratique.ch/software/logs"><code>Logs</code></a> library designed to cooperate with progress bar rendering:</p><div class="odoc-spec"><div class="spec value" id="val-logs_reporter" class="anchored"><a href="#val-logs_reporter" class="anchor"></a><code><span><span class="keyword">val</span> logs_reporter : 
  <span>?pp_header:<span><span>(<span class="xref-unresolved">Logs</span>.level * <span>string option</span>)</span> <span class="xref-unresolved">Fmt</span>.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?app:<span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span>
  <span>?dst:<span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Logs</span>.reporter</span></code></div><div class="spec-doc"><p><code>reporter</code> is like <code>Logs_fmt.reporter</code> but produces a reporter that <a href="../../Progress/index.html#val-interject_with">suspends</a> any ongoing progress bar rendering while displaying log entries, ensuring that log entries in the terminal are never overwritten by the renderer.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-instrument_logs_reporter" class="anchored"><a href="#val-instrument_logs_reporter" class="anchor"></a><code><span><span class="keyword">val</span> instrument_logs_reporter : <span><span class="xref-unresolved">Logs</span>.reporter <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Logs</span>.reporter</span></code></div><div class="spec-doc"><p><code>instrument_reporter r</code> wraps the synchronous reporter <code>r</code> to ensure that any progress bar rendering is suspended while messages are being constructed for <code>r</code>.</p><p><b>Note</b>: <i>to ensure that log entries are not overwritten by the <code>Progress</code> renderer, <code>r</code> must flush any log entries to the terminal synchronously: as soon as they are reported. This is true of the <code>Logs</code> reporters built by <code>Logs</code>.format_reporter and <code>Logs_fmt</code>.reporter. An asynchronous reporter should use <a href="#val-interject_with"><code>interject_with</code></a> to delimit its flushing action instead.</i></p></div></div><h4 id="manual-lifecycle-management"><a href="#manual-lifecycle-management" class="anchor"></a>Manual lifecycle management</h4><p>Functions for explicitly starting and stopping the process of rendering a bar; useful when the code doing the progress reporting cannot be conveniently delimited inside <a href="#val-with_reporter"><code>with_reporter</code></a>. All <a href="Display/index.html"><code>Display</code></a>s must be properly <a href="Display/index.html#val-finalise">finalised</a>, and it is not possible to interleave rendering of displays.</p><div class="odoc-spec"><div class="spec module" id="module-Reporter" class="anchored"><a href="#module-Reporter" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Reporter/index.html">Reporter</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Display" class="anchored"><a href="#module-Display" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Display/index.html">Display</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></div></body></html>